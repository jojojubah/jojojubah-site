<!DOCTYPE html>
<!-- 
    GAME HTML FILE - Located at /game/index.html
    This is the WASM game loader for Bitcoin Runner
    NOT the main website index.html
-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>â‚¿itcoin Runner - WASM Game</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #0f0f5e;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        canvas {
            display: block;
            max-width: 90vw;
            max-height: 90vh;
            border: 2px solid #333;
            background: black;
        }
        
        #loading {
            color: white;
            text-align: center;
            position: absolute;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="loading">Loading Bitcoin Runner...</div>
    <canvas id="glcanvas" width="800" height="600" tabindex='1' style="display: none;"></canvas>
    
    <script>
        // First, let's add some debugging to see what's happening
        console.log('Starting Bitcoin Runner WASM loader...');
        
        const canvas = document.getElementById('glcanvas');
        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
            document.body.innerHTML = '<div style="color: white; text-align: center; padding: 20px;"><h2>WebGL not supported</h2><p>Your browser doesn\'t support WebGL which is required for this game.</p></div>';
            throw new Error('WebGL not supported');
        }
        
        console.log('WebGL context created:', gl.getParameter(gl.VERSION));
        
        let wasm_memory;
        let wasm_exports = {};
        
        // More comprehensive macroquad/miniquad setup
        window.miniquad_add_js_object = function(id, obj) {
            window.wasm_js_objects = window.wasm_js_objects || [];
            window.wasm_js_objects[id] = obj;
        };
        
        // Audio setup
        let audio_context;
        try {
            audio_context = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.warn('Web Audio API not available:', e);
        }
        
        async function load_wasm() {
            try {
                console.log('Fetching WASM file...');
                const response = await fetch('./target/wasm32-unknown-unknown/release/bitcoin_runner.wasm');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const bytes = await response.arrayBuffer();
                console.log('WASM file loaded, size:', bytes.byteLength, 'bytes');
                
                // Complete import object for macroquad with WebGL bindings
                const imports = {
                    env: {
                        // Math functions that Rust/WASM needs
                        sin: Math.sin,
                        cos: Math.cos,
                        tan: Math.tan,
                        asin: Math.asin,
                        acos: Math.acos,
                        atan: Math.atan,
                        atan2: Math.atan2,
                        exp: Math.exp,
                        log: Math.log,
                        sqrt: Math.sqrt,
                        pow: Math.pow,
                        floor: Math.floor,
                        ceil: Math.ceil,
                        round: Math.round,
                        fabs: Math.abs,
                        abs: Math.abs,
                        
                        // Random functions
                        drand48: Math.random,
                        srand48: function(seed) { console.log('srand48 called with seed:', seed); },
                        
                        // Console/debug functions
                        console_debug: function(ptr, len) {
                            const str = new TextDecoder().decode(new Uint8Array(wasm_memory.buffer, ptr, len));
                            console.debug('[WASM DEBUG]', str);
                        },
                        console_log: function(ptr, len) {
                            const str = new TextDecoder().decode(new Uint8Array(wasm_memory.buffer, ptr, len));
                            console.log('[WASM LOG]', str);
                        },
                        console_info: function(ptr, len) {
                            const str = new TextDecoder().decode(new Uint8Array(wasm_memory.buffer, ptr, len));
                            console.info('[WASM INFO]', str);
                        },
                        console_warn: function(ptr, len) {
                            const str = new TextDecoder().decode(new Uint8Array(wasm_memory.buffer, ptr, len));
                            console.warn('[WASM WARN]', str);
                        },
                        console_error: function(ptr, len) {
                            const str = new TextDecoder().decode(new Uint8Array(wasm_memory.buffer, ptr, len));
                            console.error('[WASM ERROR]', str);
                        },
                        
                        // Time functions
                        now: function() {
                            return Date.now() / 1000.0;
                        },
                        
                        // Canvas functions
                        canvas_width: function() { 
                            console.log('canvas_width called:', canvas.width);
                            return canvas.width; 
                        },
                        canvas_height: function() { 
                            console.log('canvas_height called:', canvas.height);
                            return canvas.height; 
                        },
                        
                        // WebGL initialization functions (this is what was missing!)
                        init_webgl: function(antialias, depth, stencil, alpha, premultiplied_alpha) {
                            console.log('init_webgl called with:', { antialias, depth, stencil, alpha, premultiplied_alpha });
                            // WebGL context is already created above
                            return 0; // success
                        },
                        
                        setup_canvas_size: function(width, height) {
                            console.log('setup_canvas_size called with:', width, height);
                            canvas.width = width;
                            canvas.height = height;
                            gl.viewport(0, 0, width, height);
                            return 0; // success
                        },
                        
                        get_webgl_context: function() {
                            console.log('get_webgl_context called');
                            return 0; // We use the global gl context
                        },
                        
                        // Additional canvas functions that might be needed
                        set_canvas_size: function(width, height) {
                            console.log('set_canvas_size called with:', width, height);
                            canvas.width = width;
                            canvas.height = height;
                            gl.viewport(0, 0, width, height);
                        },
                        
                        get_canvas_size: function() {
                            console.log('get_canvas_size called');
                            return [canvas.width, canvas.height];
                        },
                        
                        resize_canvas: function(width, height) {
                            console.log('resize_canvas called with:', width, height);
                            canvas.width = width;
                            canvas.height = height;
                            canvas.style.width = width + 'px';
                            canvas.style.height = height + 'px';
                            gl.viewport(0, 0, width, height);
                        },
                        
                        // DPI and screen functions
                        dpi_scale: function() {
                            const dpi = window.devicePixelRatio || 1.0;
                            console.log('dpi_scale called, returning:', dpi);
                            return dpi;
                        },
                        
                        screen_size: function() {
                            console.log('screen_size called');
                            return [window.screen.width, window.screen.height];
                        },
                        
                        window_size: function() {
                            console.log('window_size called');
                            return [window.innerWidth, window.innerHeight];
                        },
                        
                        // Animation loop - this is crucial for the game to run!
                        run_animation_loop: function(callback_ptr) {
                            console.log('run_animation_loop called with callback:', callback_ptr);
                            
                            function animationFrame() {
                                // Call the WASM callback function
                                if (wasm_exports && wasm_exports.__indirect_function_table) {
                                    try {
                                        wasm_exports.__indirect_function_table.get(callback_ptr)();
                                    } catch (e) {
                                        console.error('Animation callback error:', e);
                                    }
                                }
                                requestAnimationFrame(animationFrame);
                            }
                            
                            // Start the animation loop
                            requestAnimationFrame(animationFrame);
                        },
                        
                        // Request animation frame wrapper
                        request_animation_frame: function(callback_ptr) {
                            console.log('request_animation_frame called');
                            requestAnimationFrame(() => {
                                if (wasm_exports && callback_ptr) {
                                    try {
                                        wasm_exports.__indirect_function_table.get(callback_ptr)();
                                    } catch (e) {
                                        console.error('RAF callback error:', e);
                                    }
                                }
                            });
                        },
                        
                        // Performance timing functions
                        performance_now: function() {
                            return performance.now() / 1000.0; // Return in seconds
                        },
                        
                        // WebGL function bindings - these map directly to WebGL calls
                        glBindTexture: function(target, texture) {
                            gl.bindTexture(target, texture);
                        },
                        
                        glGenTextures: function(n, textures_ptr) {
                            const texture = gl.createTexture();
                            // Store texture ID (simplified - in real implementation would handle array)
                            return texture;
                        },
                        
                        glDeleteTextures: function(n, textures_ptr) {
                            // Would delete textures here
                        },
                        
                        glTexImage2D: function(target, level, internalformat, width, height, border, format, type, pixels_ptr) {
                            gl.texImage2D(target, level, internalformat, width, height, border, format, type, null);
                        },
                        
                        glTexParameteri: function(target, pname, param) {
                            gl.texParameteri(target, pname, param);
                        },
                        
                        glUseProgram: function(program) {
                            gl.useProgram(program);
                        },
                        
                        glCreateShader: function(type) {
                            return gl.createShader(type);
                        },
                        
                        glShaderSource: function(shader, count, string_ptr, length_ptr) {
                            // Would set shader source here
                        },
                        
                        glCompileShader: function(shader) {
                            gl.compileShader(shader);
                        },
                        
                        glCreateProgram: function() {
                            return gl.createProgram();
                        },
                        
                        glAttachShader: function(program, shader) {
                            gl.attachShader(program, shader);
                        },
                        
                        glLinkProgram: function(program) {
                            gl.linkProgram(program);
                        },
                        
                        glViewport: function(x, y, width, height) {
                            gl.viewport(x, y, width, height);
                        },
                        
                        glClear: function(mask) {
                            gl.clear(mask);
                        },
                        
                        glClearColor: function(r, g, b, a) {
                            gl.clearColor(r, g, b, a);
                        },
                        
                        glEnable: function(cap) {
                            gl.enable(cap);
                        },
                        
                        glDisable: function(cap) {
                            gl.disable(cap);
                        },
                        
                        glBlendFunc: function(sfactor, dfactor) {
                            gl.blendFunc(sfactor, dfactor);
                        },
                        
                        glDrawArrays: function(mode, first, count) {
                            gl.drawArrays(mode, first, count);
                        },
                        
                        glDrawElements: function(mode, count, type, indices) {
                            gl.drawElements(mode, count, type, indices);
                        },
                        
                        // Vertex attribute functions
                        glVertexAttribPointer: function(index, size, type, normalized, stride, pointer) {
                            gl.vertexAttribPointer(index, size, type, normalized, stride, pointer);
                        },
                        
                        glEnableVertexAttribArray: function(index) {
                            gl.enableVertexAttribArray(index);
                        },
                        
                        glDisableVertexAttribArray: function(index) {
                            gl.disableVertexAttribArray(index);
                        },
                        
                        // Buffer functions
                        glGenBuffers: function(n, buffers_ptr) {
                            return gl.createBuffer();
                        },
                        
                        glBindBuffer: function(target, buffer) {
                            gl.bindBuffer(target, buffer);
                        },
                        
                        glBufferData: function(target, size, data_ptr, usage) {
                            gl.bufferData(target, size, usage);
                        },
                        
                        // Uniform functions
                        glGetUniformLocation: function(program, name_ptr) {
                            return 0; // Simplified
                        },
                        
                        glUniform1f: function(location, x) {
                            gl.uniform1f(location, x);
                        },
                        
                        glUniform2f: function(location, x, y) {
                            gl.uniform2f(location, x, y);
                        },
                        
                        glUniform3f: function(location, x, y, z) {
                            gl.uniform3f(location, x, y, z);
                        },
                        
                        glUniform4f: function(location, x, y, z, w) {
                            gl.uniform4f(location, x, y, z, w);
                        },
                        
                        glUniformMatrix4fv: function(location, count, transpose, value_ptr) {
                            // Would set matrix uniform here
                        },
                        
                        // Input functions
                        is_key_down: function(key) {
                            // Simple key state tracking - you could expand this
                            return 0;
                        },
                        
                        is_key_pressed: function(key) {
                            // Simple key press tracking - you could expand this
                            return 0;
                        },
                        
                        is_mouse_button_pressed: function(button) {
                            // Simple mouse tracking - you could expand this
                            return 0;
                        },
                        
                        // Texture/rendering functions
                        texture_new: function() { return 0; },
                        texture_delete: function() {},
                        texture_update: function() {},
                        
                        // Shader functions
                        shader_new: function() { return 0; },
                        shader_delete: function() {},
                        
                        // Buffer functions
                        buffer_new: function() { return 0; },
                        buffer_delete: function() {},
                        buffer_update: function() {},
                        
                        // Rendering functions
                        clear: function(r, g, b, a) {
                            gl.clearColor(r, g, b, a);
                            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                        },
                        
                        draw: function() {
                            // Drawing commands would go here
                        },
                        
                        present: function() {
                            // Present/swap buffers - WebGL handles this automatically
                        },
                        
                        // Panic handler
                        abort: function() {
                            console.error('WASM abort() called!');
                            throw new Error('WASM program aborted');
                        },
                        
                        // Memory functions
                        __assert_fail: function() {
                            console.error('WASM assertion failed!');
                            throw new Error('WASM assertion failed');
                        },
                        
                        // JavaScript object functions
                        js_object_new: function() { return 0; },
                        js_object_call: function() { return 0; },
                        js_object_release: function() { },
                        
                        // File system functions (placeholder)
                        fs_load_file: function() { return 0; },
                        
                        // Audio functions (placeholder)
                        audio_load: function() { return 0; },
                        audio_play: function() {},
                        audio_stop: function() {},
                    }
                };
                
                console.log('Instantiating WASM module...');
                const wasmModule = await WebAssembly.instantiate(bytes, imports);
                wasm_memory = wasmModule.instance.exports.memory;
                wasm_exports = wasmModule.instance.exports;
                
                console.log('WASM module instantiated successfully');
                console.log('Available exports:', Object.keys(wasm_exports));
                
                // Hide loading message and show canvas
                document.getElementById('loading').style.display = 'none';
                canvas.style.display = 'block';
                canvas.focus();
                
                console.log('Starting game...');
                
                // Try different entry points
                if (wasm_exports.main) {
                    console.log('Calling main()...');
                    wasm_exports.main();
                } else if (wasm_exports._start) {
                    console.log('Calling _start()...');
                    wasm_exports._start();
                } else if (wasm_exports.__main_argc_argv) {
                    console.log('Calling __main_argc_argv()...');
                    wasm_exports.__main_argc_argv(0, 0);
                } else {
                    console.error('No suitable entry point found in WASM module');
                    console.log('Available exports:', Object.keys(wasm_exports));
                }
                
                console.log('Game should be running now!');
                
            } catch (error) {
                console.error('Failed to load WASM:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ff6b7a; text-align: center;">
                        <h2>Game Loading Failed</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Check browser console for details</strong></p>
                        <p>Make sure the game was built with:</p>
                        <code>cargo build --target wasm32-unknown-unknown --release</code>
                        <br><br>
                        <small>Current URL: ${window.location.href}</small>
                    </div>
                `;
            }
        }
        
        // Input handling
        canvas.addEventListener('click', function() {
            canvas.focus();
            console.log('Canvas focused');
        });
        
        // Keyboard input
        canvas.addEventListener('keydown', function(e) {
            console.log('Key pressed:', e.code);
            if (e.code === 'Space') {
                e.preventDefault();
            }
        });
        
        // Mouse input
        canvas.addEventListener('mousedown', function(e) {
            console.log('Mouse clicked at:', e.offsetX, e.offsetY);
        });
        
        // Start loading
        console.log('Calling load_wasm()...');
        load_wasm();
    </script>
</body>
</html>